{% extends "base.html" %}
{% load static %}

{% block title %}Chat Assistant{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: 90vh;
    max-width: 800px;
    margin: 20px auto;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    overflow: hidden;
    background: #fff;
}
.chat-header { padding: 15px; background: #2563eb; color: white; font-weight: bold; text-align: center; }
.chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: #f9fafb; }
.chat-message { margin-bottom: 12px; display: flex; max-width: 70%; }
.chat-message.user { justify-content: flex-end; margin-left: auto; }
.chat-message.user p { background: #2563eb; color: white; border-radius: 20px 20px 0 20px; }
.chat-message.assistant p { background: #e5e7eb; color: #111; border-radius: 20px 20px 20px 0; }
.chat-message p { padding: 10px 15px; word-wrap: break-word; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.chat-input { display: flex; align-items: center; padding: 10px; border-top: 1px solid #ddd; background: #fff; gap: 8px; }
.chat-input input[type="text"] { flex: 1; border: none; outline: none; padding: 10px 15px; border-radius: 20px; background: #f3f4f6; font-size: 14px; }

/* N√∫t icon */
.icon-btn, .send-btn {
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    padding: 0;
}
.icon-btn img, .send-btn img {
    width: 24px;  /* scale v·ª´a v·ªõi n√∫t */
    height: 24px;
}
.icon-btn { background: #fff; }
.icon-btn:hover { background: #f3f4f6; }

.send-btn { background: #2563eb; }
.send-btn:hover { background: #1d4ed8; }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">ü§ñ Tr·ª£ l√Ω ·∫£o</div>

    <div class="chat-messages" id="chat-messages">
        <div class="chat-message assistant">
            <p>Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o c·ªßa b·∫°n. H√£y nh·∫≠p c√¢u h·ªèi ph√≠a d∆∞·ªõi üëã</p>
        </div>
    </div>

    <div class="chat-input">
        <button class="icon-btn" id="emoji-btn" title="Ch√®n emoji">
            <img src="{% static 'home/images/3561853_emoji_emoticon_happy_laugh_icon.png' %}" alt="Emoji">
        </button>
        <button class="icon-btn" id="attachment-btn" title="ƒê√≠nh k√®m file">
            <img src="{% static 'home/images/352032_attach_file_icon.png' %}" alt="Attach">
        </button>
        <input type="file" id="file-input" style="display:none;">
        <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button class="icon-btn" id="voice-btn" title="Ghi √¢m">
            <img src="{% static 'home/images/2205213_mic_microphone_record_speak_icon.png' %}" alt="Mic">
        </button>
        <button id="send-btn" class="send-btn" title="G·ª≠i">
            <img src="{% static 'home/images/7830825_send_email_icon.png' %}" alt="Send">
        </button>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
// L·∫•y CSRF token t·ª´ cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", function(){
    const sendBtn = document.getElementById("send-btn");
    const messageInput = document.getElementById("message-input");
    const fileInput = document.getElementById("file-input");
    const voiceBtn = document.getElementById("voice-btn");
    const emojiBtn = document.getElementById("emoji-btn");
    const attachmentBtn = document.getElementById("attachment-btn");
    const chatMessages = document.getElementById("chat-messages");

    function appendMessage(sender, text){
        const div = document.createElement("div");
        div.classList.add("chat-message", sender);
        div.innerHTML = `<p>${text}</p>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage(){
        const message = messageInput.value.trim();
        if(message === "") return;
        appendMessage("user", message);
        messageInput.value = "";

        const loading = document.createElement("div");
        loading.classList.add("chat-message", "assistant");
        loading.innerHTML = `<p><i>AI ƒëang tr·∫£ l·ªùi...</i></p>`;
        chatMessages.appendChild(loading);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        fetch("{% url 'home:chat_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({message: message})
        })
        .then(res => {
            if(!res.ok) throw new Error("HTTP error " + res.status);
            return res.json();
        })
        .then(data => {
            chatMessages.removeChild(loading);
            appendMessage("assistant", data.reply || "[Kh√¥ng c√≥ ph·∫£n h·ªìi]");
        })
        .catch(err => {
            chatMessages.removeChild(loading);
            appendMessage("assistant", "[L·ªói g·ª≠i tin nh·∫Øn]");
            console.error("Fetch error:", err);
        });
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", function(e){
        if(e.key === "Enter"){ e.preventDefault(); sendMessage(); }
    });

    emojiBtn.addEventListener("click", () => { messageInput.value += " üòä"; messageInput.focus(); });
    attachmentBtn.addEventListener("click", () => { fileInput.click(); });
    fileInput.addEventListener("change", (e) => {
        if(e.target.files.length > 0){
            appendMessage("user", "[ƒê√£ ch·ªçn file: " + e.target.files[0].name + "]");
        }
    });
    voiceBtn.addEventListener("click", () => { appendMessage("user", "[Ghi √¢m s·∫Ω ƒë∆∞·ª£c h·ªó tr·ª£ sau]"); });
});
</script>
{% endblock %}
