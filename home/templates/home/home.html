{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block style %}
<style>
:root {
  --primary: #007aff;
  --secondary: #00cfff;
  --success: #4caf50;
  --warning: #ff9800;
  --purple: #9c27b0;
  --card-bg: rgba(255, 255, 255, 0.88);
  --card-bg-dark: rgba(28, 28, 28, 0.9);
  --shadow: rgba(0, 0, 0, 0.12);
  --radius: 20px;
  --speed: 0.3s ease;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* === Card === */
.card {
  background: var(--card-bg);
  backdrop-filter: blur(14px);
  border-radius: var(--radius);
  padding: 24px 32px;
  margin: 24px auto;
  max-width: 800px;
  box-shadow: 0 12px 28px var(--shadow);
  transition: all var(--speed);
  font-family: var(--font);
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 16px 36px rgba(0, 0, 0, 0.18);
}
.card h2 {
  margin: 0 0 12px 0;
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
}

/* === Welcome === */
.welcome h2 { font-size: 28px; }
.welcome .sub { font-size: 16px; color: #555; }

/* === Stats === */
.status-boxes {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-top: 20px;
}
.status {
  flex: 1 1 150px;
  min-width: 150px;
  padding: 18px;
  border-radius: var(--radius);
  text-align: center;
  font-weight: 600;
  color: white;
  transition: all var(--speed);
}
.status span {
  display: block;
  font-size: 20px;
  margin-top: 6px;
  font-weight: 700;
}
.status.assigned { background: linear-gradient(135deg, #007aff, #00cfff); }
.status.sent { background: linear-gradient(135deg, #ff9800, #ffb74d); }
.status.signed { background: linear-gradient(135deg, #9c27b0, #ba68c8); }
.status.approved { background: linear-gradient(135deg, #4caf50, #81c784); }
.status:hover { transform: translateY(-3px) scale(1.04); }

/* === Chart Section === */
.chart {
  text-align: center;
}
.chart h2 {
  font-size: 22px;
  margin: 28px 0 16px 0;
}
canvas {
  max-width: 100%;
  height: auto;
}

/* === Dark Mode === */
@media(prefers-color-scheme: dark){
  .card { background: var(--card-bg-dark); color: #fff; }
  .welcome .sub { color: #ccc; }
}

/* === Responsive === */
@media(max-width:768px){
  .card { padding: 18px 20px; margin: 16px; }
  .welcome h2 { font-size: 22px; }
  .status-boxes { flex-direction: column; }
}
</style>
{% endblock %}

{% block content %}
<div class="card welcome">
  <h2>Welcome to the Dashboard üëã</h2>
  <p class="sub">Hi {{ user.first_name|default:"User" }}, explore your account and activities here.</p>
</div>

<div class="card stats">
  <h2>Quick Stats</h2>
  <div class="status-boxes">
    <div class="status assigned">
      üìö Studying Courses
      <span>{{ ongoing_courses|default:0 }}</span>
    </div>
    <div class="status sent">
      üèÜ Results
      <span>{{ completed_courses|default:0 }}</span>
    </div>
    <div class="status signed">
      üìÑ Documents
      <span>{{ documents_count|default:0 }}</span>
    </div>
    <div class="status approved">
      üöÄ Progress
      <span>{{ avg_progress|default:0 }}%</span>
    </div>
  </div>
</div>

<div class="card chart">
  <h2>Learning Progress</h2>
  <canvas id="progressChart"></canvas>

  <h2>User Activity</h2>
  <canvas id="activityChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* === Doughnut Chart === */
const ctx = document.getElementById('progressChart').getContext('2d');
new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Completed', 'Ongoing'],
    datasets: [{
      data: [{{ completed_courses|default:0 }}, {{ ongoing_courses|default:0 }}],
      backgroundColor: ['#4caf50','#ff9800'],
      borderColor: '#fff',
      borderWidth: 2,
      hoverOffset: 8
    }]
  },
  options: {
    cutout: '60%',
    plugins: {
      legend: {
        position: 'bottom',
        labels: { color: 'inherit', font: { size: 14, weight: '600' } }
      }
    }
  }
});

/* === Line Chart: User Activity === */
const activityCtx = document.getElementById('activityChart').getContext('2d');
const activityDates = JSON.parse('{{ action_dates|escapejs }}');
const activityCounts = JSON.parse('{{ action_counts|escapejs }}');

function formatTime(seconds){
  const h = Math.floor(seconds/3600);
  const m = Math.floor((seconds%3600)/60);
  const s = seconds%60;
  return (h>0? h+"h ":"") + (m>0? m+"m ":"") + s+"s";
}

new Chart(activityCtx, {
  type: 'line',
  data: {
    labels: activityDates,
    datasets: [{
      label: 'Time Spent',
      data: activityCounts,
      borderColor: '#007aff',
      backgroundColor: 'rgba(0,122,255,0.2)',
      fill: true,
      tension: 0.3,
      pointRadius: 4
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        ticks: { callback: val => formatTime(val) },
        title: { display: true, text: "Duration" }
      },
      x: { title: { display: true, text: "Date" } }
    },
    plugins: { legend: { labels: { color: 'inherit' } } }
  }
});
</script>
{% endblock %}
