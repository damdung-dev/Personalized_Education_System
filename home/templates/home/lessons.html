{% extends "base.html" %}
{% load static %}

{% block title %}Bài học video{% endblock %}

{% block style %}
<style>
:root {
  --primary: #007bff;
  --success: #28a745;
  --bg-light: #f8f9fa;
  --bg-dark: #1e1e1e;
  --radius: 14px;
  --shadow: 0 6px 20px rgba(0,0,0,0.15);
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

/* Container */
.lesson-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 32px 16px;
  background: var(--bg-light);
  min-height: 100vh;
  font-family: var(--font);
}

/* Video wrapper */
.video-wrapper {
  width: 100%;
  max-width: 960px;
}
.lesson-video {
  width: 100%;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  background: black;
}

/* Action buttons */
.lesson-actions {
  margin-top: 24px;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
  width: 100%;
  max-width: 400px;
}
.lesson-actions button {
  flex: 1 1 45%; /* 2 nút ngang hàng, co giãn */
  padding: 12px 22px;
  font-size: 16px;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  text-align: center;
}
.btn-back {
  background: var(--primary);
  color: #fff;
}
.btn-done {
  background: var(--success);
  color: #fff;
}
.btn-back:hover {
  background: #0056b3;
  transform: translateY(-2px);
}
.btn-done:hover {
  background: #218838;
  transform: translateY(-2px);
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  .lesson-container {
    background: var(--bg-dark);
    color: #fff;
  }
  .lesson-actions button {
    color: #fff;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="lesson-container">
  <div class="video-wrapper">
    <video id="lesson-video" controls playsinline class="lesson-video">
      <source src="{{ lesson.video_file.url }}" type="video/mp4">
      Trình duyệt của bạn không hỗ trợ video.
    </video>
  </div>

  <div class="lesson-actions">
    <button onclick="goBack()" class="btn-back">⬅️ Quay lại</button>
    <button onclick="markDone()" class="btn-done">✅ Hoàn thành</button>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
const lessonId = "{{ lesson.id }}";

// Gửi action về server
function logAction(action) {
  fetch(`/home/lesson/${lessonId}/log-action/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: "action=" + action,
  }).catch(err => console.error("Log error:", err));
}

// Quay lại
function goBack() {
  logAction("back");
  window.history.back();
}

// Đánh dấu hoàn thành
function markDone() {
  logAction("done");
  alert("✅ Bạn đã hoàn thành bài học!");
}

// Video events
const video = document.getElementById("lesson-video");
video.addEventListener("play", () => logAction("play"));
video.addEventListener("pause", () => logAction("pause"));
video.addEventListener("ended", () => logAction("done"));

// Trước khi rời trang
window.addEventListener("beforeunload", () => logAction("back"));
</script>
{% endblock %}
